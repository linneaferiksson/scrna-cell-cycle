---
title: "Seurat_protocol_Linnea"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load library

```{r library}
library(dplyr)
library(Seurat)
library(data.table)
# load data from Seurat package
#data(cc.genes)

# segregate this list into markers of G2/M phase and markers of S phase
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
```

## Load the dataset

```{r load}
feature_counts.data <- read.table(file = "/Users/linneaeriksson/Desktop/Tillämpad bioinformatik/scrna-cell-cycle/feature_counts.table.tsv", 
                                  sep = "\t",
                                  header = TRUE,
                                  quote = "",
                                  stringsAsFactors = FALSE)
dim(x=feature_counts.data)
head(x = colnames(x = feature_counts.data))
```

## Remove data that is not sc from dataset

```{r sc}
removeIDs <- function(feature_counts.data) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(feature_counts.data)) {
    if(grepl(".dil.", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
    if(grepl(".FACS.", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
    if(grepl("bulk", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- feature_counts.data[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

feature_counts_SC <- removeIDs(feature_counts.data)
dim(feature_counts_SC)
head(x = colnames(x = feature_counts_SC))

```

## Remove columns that are not of interest from dataset

```{r removeColumns}
feature_counts_SC= feature_counts_SC[,-2:-6]
dim(feature_counts_SC)
head(x = colnames(x = feature_counts_SC))
```

## Load file for correct gene names

```{r load2}
geneInfoFile <- read.table(file = "/Users/linneaeriksson/Desktop/Tillämpad bioinformatik/scrna-cell-cycle/geneInfo.QC.method.seurat.SCORPIUS.tsv", 
                           sep = "\t",
                           header = TRUE,
                           quote = "",
                           stringsAsFactors = FALSE)

#only protein coding genes
geneInfoFile = geneInfoFile[geneInfoFile$gene_biotype == "protein_coding",] 

#only genes represented with one unique ensembl ID

tmp = data.frame(table(geneInfoFile$external_gene_name))
tmp = tmp[tmp$Freq ==1, ]
geneInfoFile = geneInfoFile[geneInfoFile$external_gene_name %in% tmp$Var1, ]


dim(x=geneInfoFile)
```

## Select relevant columns

```{r select}

geneInfoNames = geneInfoFile %>%  select(Geneid, external_gene_name)
head(geneInfoNames)
dim(x=geneInfoNames)

intersect( g2m.genes, geneInfoNames$external_gene_name)
#intersect( s.genes, rownames(geneInfo))

```


## Perform inner join 

```{r innerJoin}

#Comb and Ref
geneInfo = inner_join(geneInfoNames, feature_counts_SC)
intersect( g2m.genes, geneInfo$external_gene_name)

dim(x=geneInfo)
```

## Set rownames to correct gene names

```{r rownames}
#test = data.frame(make.names(geneInfo$Chr, unique =TRUE)
#length(test)

#Comb and Ref
rownames(geneInfo) =  geneInfo$external_gene_name
dim(x=geneInfo)
head(x = colnames(x = geneInfo))

```

## Remove columns in order to perform rowSums

```{r removeColumns2}
geneInfo= geneInfo[,-1:-2]
dim(geneInfo)
head(x = colnames(x = geneInfo))

intersect( g2m.genes, rownames(geneInfo))

```

## Remove genes that are not expressed

```{r expressed}
#rowSums(geneInfo)
keep <- rowSums(geneInfo)>1
geneInfo <- geneInfo[keep,]
dim(geneInfo)

intersect( g2m.genes, rownames(geneInfo))

```


## Separate Comb and Ref

```{r Separate data}

#Comb
removeIDs <- function(geneInfo) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo)) {
    if(grepl("Ref", colnames(geneInfo[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb <- removeIDs(geneInfo)
dim(geneInfo_Comb)
head(x = colnames(x = geneInfo_Comb))

#Ref
removeIDs <- function(geneInfo) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo)) {
    if(grepl("Comb", colnames(geneInfo[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Ref <- removeIDs(geneInfo)
dim(geneInfo_Ref)
head(x = colnames(x = geneInfo_Ref))
```
## Create a Seurat object out of the table

```{r Seurat}

#Comb and Ref
feature_counts_seurat <- CreateSeuratObject(counts = geneInfo, min.cells = 3)
feature_counts_seurat
feature_counts_seurat <- NormalizeData(object = feature_counts_seurat)
feature_counts_seurat <- FindVariableFeatures(object = feature_counts_seurat, selection.method = "vst")
feature_counts_seurat <- ScaleData(feature_counts_seurat, features = rownames(feature_counts_seurat))

feature_counts_seurat <- RunPCA(object = feature_counts_seurat)
DimHeatmap(feature_counts_seurat)

# Comb
feature_counts_seurat_Comb <- CreateSeuratObject(counts = geneInfo_Comb, min.cells = 3)
feature_counts_seurat_Comb
feature_counts_seurat_Comb <- NormalizeData(object = feature_counts_seurat_Comb)
feature_counts_seurat_Comb <- FindVariableFeatures(object = feature_counts_seurat_Comb, selection.method = "vst")
feature_counts_seurat_Comb <- ScaleData(feature_counts_seurat_Comb, features = rownames(feature_counts_seurat_Comb))

feature_counts_seurat_Comb <- RunPCA(object = feature_counts_seurat_Comb)
DimHeatmap(feature_counts_seurat_Comb)

#Ref
feature_counts_seurat_Ref <- CreateSeuratObject(counts = geneInfo_Ref, min.cells = 3)
feature_counts_seurat_Ref
feature_counts_seurat_Ref <- NormalizeData(object = feature_counts_seurat_Ref)
feature_counts_seurat_Ref <- FindVariableFeatures(object = feature_counts_seurat_Ref, selection.method = "vst")
feature_counts_seurat_Ref <- ScaleData(feature_counts_seurat_Ref, features = rownames(feature_counts_seurat_Ref))

feature_counts_seurat_Ref <- RunPCA(object = feature_counts_seurat_Ref)
DimHeatmap(feature_counts_seurat_Ref)

```


## Assign cell-cycle scores

```{r Scoring}

#Comb and Ref
s.genes

intersect( g2m.genes, rownames(geneInfo$external_gene_name))
intersect( s.genes, rownames(geneInfo))

feature_counts_seurat <- CellCycleScoring(feature_counts_seurat, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat@meta.data
head(x = colnames(x = feature_counts_seurat))
#RidgePlot(feature_counts_seurat, features = c("PCNA", "TOP2A", "MCM6", "MKI67"), ncol = 2)
feature_counts_seurat <- RunPCA(feature_counts_seurat, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat)

# Comb
intersect( g2m.genes, rownames(geneInfo_Comb$external_gene_name))
intersect( s.genes, rownames(geneInfo_Comb))

feature_counts_seurat_Comb <- CellCycleScoring(feature_counts_seurat_Comb, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Comb@meta.data
head(x = colnames(x = feature_counts_seurat_Comb))

feature_counts_seurat_Comb <- RunPCA(feature_counts_seurat_Comb, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Comb)

#Ref
intersect( g2m.genes, rownames(geneInfo_Ref$external_gene_name))
intersect( s.genes, rownames(geneInfo_Ref))

feature_counts_seurat_Ref <- CellCycleScoring(feature_counts_seurat_Ref, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Ref@meta.data
head(x = colnames(x = feature_counts_seurat_Ref))
feature_counts_seurat <- RunPCA(feature_counts_seurat_Ref, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Ref)


```

## Plotting the third PCA component
``` {r experimentPCA}

#?DimHeatmap
DimHeatmap(feature_counts_seurat, dims = 1:3)
DimHeatmap(feature_counts_seurat_Comb, dims = 1:3)
DimHeatmap(feature_counts_seurat_Ref, dims = 1:3)

#?PCAPlot
PCAPlot(feature_counts_seurat, dims = c(1, 2))
PCAPlot(feature_counts_seurat, dims = c(2, 3))
PCAPlot(feature_counts_seurat, dims = c(1, 3))

PCAPlot(feature_counts_seurat_Comb, dims = c(1, 2))
PCAPlot(feature_counts_seurat_Comb, dims = c(2, 3))
PCAPlot(feature_counts_seurat_Comb, dims = c(1, 3))

PCAPlot(feature_counts_seurat_Ref, dims = c(1, 2))
PCAPlot(feature_counts_seurat_Ref, dims = c(2, 3))
PCAPlot(feature_counts_seurat_Ref, dims = c(1, 3))

#?PCASigGenes
#PCASigGenes(feature_counts_seurat, pcs.use = 2:3)

#feature_counts_seurat_Ref@reductions$pca@feature.loadings[,"PC_2"]

#feature_counts_seurat_Ref@reductions$pca@feature.loadings


```