---
title: "Seurat_protocol_4"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load library

```{r library}
library(dplyr)
library(Seurat)
library(data.table)
# load data from Seurat package
#data(cc.genes)

# segregate this list into markers of G2/M phase and markers of S phase
s.genes <- cc.genes$s.genes
g2m.genes <- cc.genes$g2m.genes
```

## Load the dataset

```{r load}
feature_counts.data <- read.table(file = "/Users/annaasklof/Desktop/Seurat/S/Data/feature_counts.table.tsv", 
                                  sep = "\t",
                                  header = TRUE,
                                  quote = "",
                                  stringsAsFactors = FALSE)
dim(x=feature_counts.data)
head(x = colnames(x = feature_counts.data))
feature_counts.data
```

## Count Comb and Ref samples

```{r count samples}
#Comb
#removeIDs <- function(feauture_counts.data) {
 # column_indices_ID <- c()
  
  #for(i in 1:ncol(feature_counts.data)) {
   # if(grepl("Ref", colnames(feature_counts.data[i]))) {
  #    column_indices_ID <- c(column_indices_ID, i)
   # }
  #}
  #feature_counts_removedColumns <- c()
  #feature_counts_removedColumns <- feature_counts.data[,-column_indices_ID]
  #return(feature_counts_removedColumns)
#}

#geneInfo_Comb <- removeIDs(feature_counts.data)
#dim(geneInfo_Comb)
#head(x = colnames(x = geneInfo_Comb))

#Ref
#removeIDs <- function(feature_counts.data) {
#  column_indices_ID <- c()
#  
#  for(i in 1:ncol(feature_counts.data)) {
#    if(grepl("Comb", colnames(feature_counts.data[i]))) {
#      column_indices_ID <- c(column_indices_ID, i)
#    }
#  }
#  feature_counts_removedColumns <- c()
#  feature_counts_removedColumns <- feature_counts.data[,-column_indices_ID]
#  return(feature_counts_removedColumns)
#}

#geneInfo_Ref <- removeIDs(feature_counts.data)
#dim(geneInfo_Ref)
#head(x = colnames(x = geneInfo_Ref))
#geneInfo_Ref
```

## Remove data that is not sc from dataset

```{r sc}
removeIDs <- function(feature_counts.data) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(feature_counts.data)) {
    if(grepl(".dil.", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
    if(grepl(".FACS.", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
      if(grepl(".bulk.", colnames(feature_counts.data[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- feature_counts.data[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

feature_counts_SC <- removeIDs(feature_counts.data)
dim(feature_counts_SC)
head(x = colnames(x = feature_counts_SC))

```

## Remove columns that are not of interest from dataset

```{r removeColumns}
feature_counts_SC= feature_counts_SC[,-2:-6]
dim(feature_counts_SC)
head(x = colnames(x = feature_counts_SC))
head(x = feature_counts_SC)
```

## Load file for correct gene names

```{r load2}
geneInfoFile <- read.table(file = "/Users/annaasklof/Desktop/Seurat/S/Data/geneInfo.QC.method.seurat.SCORPIUS.tsv", 
                           sep = "\t",
                           header = TRUE,
                           quote = "",
                           stringsAsFactors = FALSE)

#only protein coding genes
geneInfoFile = geneInfoFile[geneInfoFile$gene_biotype == "protein_coding",] 

#only genes represented with one unique ensembl ID

tmp = data.frame(table(geneInfoFile$external_gene_name))
tmp = tmp[tmp$Freq ==1, ]
geneInfoFile = geneInfoFile[geneInfoFile$external_gene_name %in% tmp$Var1, ]


dim(x=geneInfoFile)
```

## Select relevant columns

```{r select}

geneInfoNames = geneInfoFile %>%  select(Geneid, external_gene_name)
head(geneInfoNames)
dim(x=geneInfoNames)

intersect( g2m.genes, geneInfoNames$external_gene_name)
#intersect( s.genes, rownames(geneInfo))

```

## Perform inner join 

```{r innerJoin}

#Comb and Ref
geneInfo = inner_join(geneInfoNames, feature_counts_SC)
intersect( g2m.genes, geneInfo$external_gene_name)

dim(x=geneInfo)
```

## Set rownames to correct gene names

```{r rownames}
#test = data.frame(make.names(geneInfo$Chr, unique =TRUE)
#length(test)

#Comb and Ref
rownames(geneInfo) =  geneInfo$external_gene_name
dim(x=geneInfo)
head(x = colnames(x = geneInfo))

```

## Remove columns in order to perform rowSums

```{r removeColumns2}
geneInfo= geneInfo[,-1:-2]
dim(geneInfo)
head(x = colnames(x = geneInfo))
head(x = rownames(x = geneInfo))

intersect( g2m.genes, rownames(geneInfo))
```

## Remove genes that are not expressed

```{r expressed}
#rowSums(geneInfo)
keep <- rowSums(geneInfo)>1
geneInfo <- geneInfo[keep,]
dim(geneInfo)

intersect( g2m.genes, rownames(geneInfo))
```

## Separate Comb and Ref

```{r Separate}
#Comb
removeIDs <- function(geneInfo) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo)) {
    if(grepl("Ref", colnames(geneInfo[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb <- removeIDs(geneInfo)
dim(geneInfo_Comb)
head(x = colnames(x = geneInfo_Comb))

#Ref
removeIDs <- function(geneInfo) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo)) {
    if(grepl("Comb", colnames(geneInfo[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Ref <- removeIDs(geneInfo)
dim(geneInfo_Ref)
head(x = colnames(x = geneInfo_Ref))

```
## Separate Comb_0h 

```{r Separate Comb_0h}
#Comb.0h
dim(geneInfo_Comb)
# Removes 24 h 
removeIDs <- function(geneInfo_Comb) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb)) {
    if(grepl("Comb.24", colnames(geneInfo_Comb[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_24removed<- removeIDs(geneInfo_Comb)
dim(geneInfo_Comb_24removed)
# Removes 48 h 
removeIDs <- function(geneInfo_Comb_24removed) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb_24removed)) {
    if(grepl("Comb.48", colnames(geneInfo_Comb_24removed[i]))){
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb_24removed[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_0h <- removeIDs(geneInfo_Comb_24removed)
dim(geneInfo_Comb_0h)
head(x = colnames(x = geneInfo_Comb_0h))

```
## Separate Comb_24h 

```{r Separate Comb_24h}
#Comb.0h
dim(geneInfo_Comb)
# Removes 0 h 
removeIDs <- function(geneInfo_Comb) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb)) {
    if(grepl("Comb.0", colnames(geneInfo_Comb[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_0hremoved<- removeIDs(geneInfo_Comb)
dim(geneInfo_Comb_0hremoved)

# Removes 48 h 
removeIDs <- function(geneInfo_Comb_0hremoved) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb_0hremoved)) {
    if(grepl("Comb.48", colnames(geneInfo_Comb_0hremoved[i]))){
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb_0hremoved[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_24h <- removeIDs(geneInfo_Comb_0hremoved)
dim(geneInfo_Comb_24h)
head(x = colnames(x = geneInfo_Comb_24h))

```
## Separate Comb_48h 

```{r Separate Comb_48h}
#Comb.0h
dim(geneInfo_Comb)
# Removes 0 h 
removeIDs <- function(geneInfo_Comb) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb)) {
    if(grepl("Comb.0", colnames(geneInfo_Comb[i]))) {
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_0hremoved<- removeIDs(geneInfo_Comb)
dim(geneInfo_Comb_0hremoved)

# Removes 24 h 
removeIDs <- function(geneInfo_Comb_0hremoved) {
  column_indices_ID <- c()
  
  for(i in 1:ncol(geneInfo_Comb_0hremoved)) {
    if(grepl("Comb.24", colnames(geneInfo_Comb_0hremoved[i]))){
      column_indices_ID <- c(column_indices_ID, i)
    }
  }
  feature_counts_removedColumns <- c()
  feature_counts_removedColumns <- geneInfo_Comb_0hremoved[,-column_indices_ID]
  return(feature_counts_removedColumns)
}

geneInfo_Comb_48h <- removeIDs(geneInfo_Comb_0hremoved)
dim(geneInfo_Comb_48h)
head(x = colnames(x = geneInfo_Comb_48h))

```
## Create a Seurat object out of the table

```{r Seurat}

#Comb and Ref
#feature_counts_seurat <- CreateSeuratObject(counts = geneInfo, min.cells = 3)
#feature_counts_seurat
#feature_counts_seurat <- NormalizeData(object = feature_counts_seurat)
#feature_counts_seurat <- FindVariableFeatures(object = feature_counts_seurat, selection.method = "vst")
#feature_counts_seurat <- ScaleData(feature_counts_seurat, features = rownames(feature_counts_seurat))

#feature_counts_seurat <- RunPCA(object = feature_counts_seurat)
#DimHeatmap(feature_counts_seurat)

# Comb
feature_counts_seurat_Comb <- CreateSeuratObject(counts = geneInfo_Comb, min.cells = 3)
feature_counts_seurat_Comb
feature_counts_seurat_Comb <- NormalizeData(object = feature_counts_seurat_Comb)
feature_counts_seurat_Comb <- FindVariableFeatures(object = feature_counts_seurat_Comb, selection.method = "vst")
feature_counts_seurat_Comb <- ScaleData(feature_counts_seurat_Comb, features = rownames(feature_counts_seurat_Comb))

feature_counts_seurat_Comb <- RunPCA(object = feature_counts_seurat_Comb)
DimHeatmap(feature_counts_seurat_Comb)

# Comb 0h
feature_counts_seurat_Comb_0h <- CreateSeuratObject(counts = geneInfo_Comb_0h, min.cells = 3)
feature_counts_seurat_Comb_0h
feature_counts_seurat_Comb_0h <- NormalizeData(object = feature_counts_seurat_Comb_0h)
feature_counts_seurat_Comb_0h <- FindVariableFeatures(object = feature_counts_seurat_Comb_0h, selection.method = "vst")
feature_counts_seurat_Comb_0h <- ScaleData(feature_counts_seurat_Comb_0h, features = rownames(feature_counts_seurat_Comb_0h))

feature_counts_seurat_Comb_0h <- RunPCA(object = feature_counts_seurat_Comb_0h)
DimHeatmap(feature_counts_seurat_Comb_0h)

# Comb 24h
feature_counts_seurat_Comb_24h <- CreateSeuratObject(counts = geneInfo_Comb_24h, min.cells = 3)
feature_counts_seurat_Comb_24h
feature_counts_seurat_Comb_24h <- NormalizeData(object = feature_counts_seurat_Comb_24h)
feature_counts_seurat_Comb_24h <- FindVariableFeatures(object = feature_counts_seurat_Comb_24h, selection.method = "vst")
feature_counts_seurat_Comb_24h <- ScaleData(feature_counts_seurat_Comb_24h, features = rownames(feature_counts_seurat_Comb_24h))

feature_counts_seurat_Comb_24h <- RunPCA(object = feature_counts_seurat_Comb_24h)
DimHeatmap(feature_counts_seurat_Comb_24h)

# Comb 48h
feature_counts_seurat_Comb_48h <- CreateSeuratObject(counts = geneInfo_Comb_48h, min.cells = 3)
feature_counts_seurat_Comb_48h
feature_counts_seurat_Comb_48h <- NormalizeData(object = feature_counts_seurat_Comb_48h)
feature_counts_seurat_Comb_48h <- FindVariableFeatures(object = feature_counts_seurat_Comb_48h, selection.method = "vst")
feature_counts_seurat_Comb_48h <- ScaleData(feature_counts_seurat_Comb_48h, features = rownames(feature_counts_seurat_Comb_48h))

feature_counts_seurat_Comb_48h <- RunPCA(object = feature_counts_seurat_Comb_48h)
DimHeatmap(feature_counts_seurat_Comb_48h)

#Ref
feature_counts_seurat_Ref <- CreateSeuratObject(counts = geneInfo_Ref, min.cells = 3)
feature_counts_seurat_Ref
feature_counts_seurat_Ref <- NormalizeData(object = feature_counts_seurat_Ref)
feature_counts_seurat_Ref <- FindVariableFeatures(object = feature_counts_seurat_Ref, selection.method = "vst")
feature_counts_seurat_Ref <- ScaleData(feature_counts_seurat_Ref, features = rownames(feature_counts_seurat_Ref))

feature_counts_seurat_Ref <- RunPCA(object = feature_counts_seurat_Ref)
DimHeatmap(feature_counts_seurat_Ref)

```
## Checkning S genes and G2M genes
```{r Scoring}
s.genes
g2m.genes
```
## Assign cell-cycle scores

```{r Scoring}
#Comb and Ref
#intersect( g2m.genes, rownames(geneInfo$external_gene_name))
#intersect( s.genes, rownames(geneInfo))

#feature_counts_seurat <- CellCycleScoring(feature_counts_seurat, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

#feature_counts_seurat@meta.data
#head(x = colnames(x = feature_counts_seurat))
#RidgePlot(feature_counts_seurat, features = c("PCNA", "TOP2A", "MCM6", "MKI67"), ncol = 2)
#feature_counts_seurat <- RunPCA(feature_counts_seurat, features = c(s.genes, g2m.genes))
#DimPlot(feature_counts_seurat)

# Comb
intersect( g2m.genes, rownames(geneInfo_Comb$external_gene_name))
intersect( s.genes, rownames(geneInfo_Comb))

feature_counts_seurat_Comb <- CellCycleScoring(feature_counts_seurat_Comb, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Comb$S.Score
feature_counts_seurat_Comb$G2M.Score

#feature_counts_seurat_Comb@meta.data
#head(x = colnames(x = feature_counts_seurat_Comb))

feature_counts_seurat_Comb <- RunPCA(feature_counts_seurat_Comb, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Comb)

# Comb_0h 
intersect( g2m.genes, rownames(geneInfo_Comb_0h$external_gene_name))
intersect( s.genes, rownames(geneInfo_Comb_0h))

feature_counts_seurat_Comb_0h <- CellCycleScoring(feature_counts_seurat_Comb_0h, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Comb_0h$S.Score
feature_counts_seurat_Comb_0h$G2M.Score

feature_counts_seurat_Comb_0h <- RunPCA(feature_counts_seurat_Comb_0h, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Comb_0h)

# Comb_24h 
intersect( g2m.genes, rownames(geneInfo_Comb_24h$external_gene_name))
intersect( s.genes, rownames(geneInfo_Comb_24h))

feature_counts_seurat_Comb_24h <- CellCycleScoring(feature_counts_seurat_Comb_24h, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Comb_24h$S.Score
feature_counts_seurat_Comb_24h$G2M.Score

feature_counts_seurat_Comb_24h <- RunPCA(feature_counts_seurat_Comb_24h, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Comb_24h)

# Comb_48h 
intersect( g2m.genes, rownames(geneInfo_Comb_48h$external_gene_name))
intersect( s.genes, rownames(geneInfo_Comb_48h))

feature_counts_seurat_Comb_48h <- CellCycleScoring(feature_counts_seurat_Comb_48h, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

feature_counts_seurat_Comb_48h$S.Score
feature_counts_seurat_Comb_48h$G2M.Score

feature_counts_seurat_Comb_48h <- RunPCA(feature_counts_seurat_Comb_48h, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Comb_48h)

#Ref
intersect( g2m.genes, rownames(geneInfo_Ref$external_gene_name))
intersect( s.genes, rownames(geneInfo_Ref))

feature_counts_seurat_Ref <- CellCycleScoring(feature_counts_seurat_Ref, s.features = s.genes, g2m.features = g2m.genes, set.ident = TRUE)

#feature_counts_seurat_Ref@meta.data
#head(x = colnames(x = feature_counts_seurat_Ref))
feature_counts_seurat <- RunPCA(feature_counts_seurat_Ref, features = c(s.genes, g2m.genes))
DimPlot(feature_counts_seurat_Ref)

summary(feature_counts_seurat_Ref)

#feature_counts_seurat_Ref@assays$RNA
#saveRDS(feature_counts_seurat_Comb, file = "../output/seurat_plot_comb.rds")
#saveRDS(feature_counts_seurat_Ref, file = "../output/seurat_plot_ref.rds")
```

##PCA Combdata

``` {r PCA Comb}
#Ranking of principle component
ElbowPlot(feature_counts_seurat_Comb)

#PCAPlot

#Comb and Ref
#DimPlot(feature_counts_seurat, dims = c(1, 2))
#DimPlot(feature_counts_seurat, dims = c(2, 3))
#DimPlot(feature_counts_seurat, dims = c(1, 3))

#Comb
DimPlot(feature_counts_seurat_Comb, dims = c(1, 2), plot.title = "Comb")
DimPlot(feature_counts_seurat_Comb, dims = c(2, 3))
DimPlot(feature_counts_seurat_Comb, dims = c(1, 3))
DimPlot(feature_counts_seurat_Comb, dims = c(1, 4))
DimPlot(feature_counts_seurat_Comb, dims = c(2, 4))
DimPlot(feature_counts_seurat_Comb, dims = c(3, 4))
DimPlot(feature_counts_seurat_Comb, dims = c(1, 5))
DimPlot(feature_counts_seurat_Comb, dims = c(2, 5))
DimPlot(feature_counts_seurat_Comb, dims = c(3, 5))
DimPlot(feature_counts_seurat_Comb, dims = c(4, 5))
```

##PCA Refdata

``` {r PCA Ref}

#Ranking of principle component
ElbowPlot(feature_counts_seurat_Ref)

#Ref
DimPlot(feature_counts_seurat_Ref, dims = c(1, 2))
DimPlot(feature_counts_seurat_Ref, dims = c(2, 3))
DimPlot(feature_counts_seurat_Ref, dims = c(1, 3))
DimPlot(feature_counts_seurat_Ref, dims = c(1, 4))
DimPlot(feature_counts_seurat_Ref, dims = c(2, 4))
DimPlot(feature_counts_seurat_Ref, dims = c(3, 4))
DimPlot(feature_counts_seurat_Ref, dims = c(1, 5))
DimPlot(feature_counts_seurat_Ref, dims = c(2, 5))
DimPlot(feature_counts_seurat_Ref, dims = c(3, 5))
DimPlot(feature_counts_seurat_Ref, dims = c(4, 5))
```

##Convert Seuratobject to dataframe

```{r Convert Seuratobject to dataframe}
#Convert Seuratobject to dataframe

#Comb
CombmetaData = feature_counts_seurat_Comb@meta.data
class(CombmetaData)
head(CombmetaData)

#Comb_0h
Comb_0h_metaData = feature_counts_seurat_Comb_0h@meta.data
class(Comb_0h_metaData)
head(Comb_0h_metaData)

#Comb_24h
Comb_24h_metaData = feature_counts_seurat_Comb_24h@meta.data
class(Comb_24h_metaData)
head(Comb_24h_metaData)

#Comb_48h
Comb_48h_metaData = feature_counts_seurat_Comb_48h@meta.data
class(Comb_48h_metaData)
head(Comb_48h_metaData)

#Ref
RefmetaData = feature_counts_seurat_Ref@meta.data
class(RefmetaData)
head(RefmetaData)


#Count number of genes associated with each phase
table(feature_counts_seurat_Comb@meta.data$Phase)
table(feature_counts_seurat_Comb_0h@meta.data$Phase)
table(feature_counts_seurat_Comb_24h@meta.data$Phase)
table(feature_counts_seurat_Comb_48h@meta.data$Phase)
table(feature_counts_seurat_Ref@meta.data$Phase)
#table(feature_counts_seurat@meta.data$Phase)

#Saving the result as a numeric vector
Comb_numeric_vec <- as.vector(unlist(lapply(table(feature_counts_seurat_Comb@meta.data$Phase), as.numeric)))
Ref_numeric_vec <- as.vector(unlist(lapply(table(feature_counts_seurat_Ref@meta.data$Phase), as.numeric)))
Ref_numeric_vec
Comb_numeric_vec
```

## Comparing Comb and Ref prediction

```{r Comparing Comb and Ref prediction}
#Select relevant columns
#Ref = RefmetaData %>%  select(Phase)
#head(Ref)
#dim(x=Ref)

#Comb = CombmetaData %>%  select(Phase)

#rownames(Comb) =  Comb$sample
#dim(x=Comb)
#head(Comb)
#Comb$Reference = Ref
#rownames(Comb) <- c()

#intersect
#intersect(Ref, rownames(Comb))
#head(Comb)

#Perform a join 
#Result = full_join(Comb, Ref)
#intersect( g2m.genes, geneInfo$external_gene_name)
#head(Result)
#dim(x=Result)

#cbind
#result = append(Comb,Ref)
#head(result)
#Result = Comb$Phase
#head(Result)
#Result = cbind(Comb, Ref)

```


